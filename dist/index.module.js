import{Utils as r,LockingScript as e,OP as t,TransactionSignature as n,Hash as o,UnlockingScript as i,PublicKey as s,Transaction as u,Script as a,P2PKH as c,PrivateKey as f}from"@bsv/sdk";import*as d from"js-1sat-ord";function l(r,e){(null==e||e>r.length)&&(e=r.length);for(var t=0,n=Array(e);t<e;t++)n[t]=r[t];return n}var h=/*#__PURE__*/function(){function s(){}var u=s.prototype;return u.lock=function(n,o){var i=[];if("string"==typeof n){var s=r.fromBase58Check(n);if(0!==s.prefix[0]&&111!==s.prefix[0])throw new Error("only P2PKH is supported");i=s.data}else i=n;var u=new e;return u.writeOpCode(t.OP_DUP).writeOpCode(t.OP_HASH160).writeBin(i).writeOpCode(t.OP_EQUALVERIFY).writeOpCode(t.OP_CHECKSIGVERIFY).writeBin(o.encode(!0)).writeOpCode(t.OP_CHECKSIG),u},u.userUnlock=function(r,e,t,s,u){return void 0===e&&(e="all"),void 0===t&&(t=!1),{sign:function(a,c){try{var f,d,l,h=n.SIGHASH_FORKID;"all"===e&&(h|=n.SIGHASH_ALL),"none"===e&&(h|=n.SIGHASH_NONE),"single"===e&&(h|=n.SIGHASH_SINGLE),t&&(h|=n.SIGHASH_ANYONECANPAY);var v=a.inputs[c],p=a.inputs.filter(function(r,e){return e!==c}),m=v.sourceTXID?v.sourceTXID:null==(f=v.sourceTransaction)?void 0:f.id("hex");if(!m)throw new Error("The input sourceTXID or sourceTransaction is required for transaction signing.");if(s||(s=null==(d=v.sourceTransaction)?void 0:d.outputs[v.sourceOutputIndex].satoshis),!s)throw new Error("The sourceSatoshis or input sourceTransaction is required for transaction signing.");if(u||(u=null==(l=v.sourceTransaction)?void 0:l.outputs[v.sourceOutputIndex].lockingScript),!u)throw new Error("The lockingScript or input sourceTransaction is required for transaction signing.");var g=n.format({sourceTXID:m,sourceOutputIndex:v.sourceOutputIndex,sourceSatoshis:s,transactionVersion:a.version,otherInputs:p,inputIndex:c,outputs:a.outputs,inputSequence:v.sequence||4294967295,subscript:u,lockTime:a.lockTime,scope:h}),w=r.sign(o.sha256(g)),I=new n(w.r,w.s,h),P=new i;return P.writeBin(I.toChecksigFormat()),P.writeBin(r.toPublicKey().encode(!0)),Promise.resolve(P)}catch(r){return Promise.reject(r)}},estimateLength:function(){return Promise.resolve(182)}}},u.unlock=function(r,e,t,s,u,a){return void 0===t&&(t="all"),void 0===s&&(s=!1),{sign:function(c,f){try{var d,l,h,v=n.SIGHASH_FORKID;"all"===t&&(v|=n.SIGHASH_ALL),"none"===t&&(v|=n.SIGHASH_NONE),"single"===t&&(v|=n.SIGHASH_SINGLE),s&&(v|=n.SIGHASH_ANYONECANPAY);var p=c.inputs[f],m=c.inputs.filter(function(r,e){return e!==f}),g=p.sourceTXID?p.sourceTXID:null==(d=p.sourceTransaction)?void 0:d.id("hex");if(!g)throw new Error("The input sourceTXID or sourceTransaction is required for transaction signing.");if(u||(u=null==(l=p.sourceTransaction)?void 0:l.outputs[p.sourceOutputIndex].satoshis),!u)throw new Error("The sourceSatoshis or input sourceTransaction is required for transaction signing.");if(a||(a=null==(h=p.sourceTransaction)?void 0:h.outputs[p.sourceOutputIndex].lockingScript),!a)throw new Error("The lockingScript or input sourceTransaction is required for transaction signing.");var w=n.format({sourceTXID:g,sourceOutputIndex:p.sourceOutputIndex,sourceSatoshis:u,transactionVersion:c.version,otherInputs:m,inputIndex:f,outputs:c.outputs,inputSequence:p.sequence||4294967295,subscript:a,lockTime:c.lockTime,scope:v}),I=r.sign(o.sha256(w)),P=new n(I.r,I.s,v),S=new i;return S.writeBin(P.toChecksigFormat()),S.writeScript(e),Promise.resolve(S)}catch(r){return Promise.reject(r)}},estimateLength:function(){return Promise.resolve(182)}}},s}();function v(r,e){try{var t=r()}catch(r){return e(r)}return t&&t.then?t.then(void 0,e):t}function p(r,e,t){if(!r.s){if(t instanceof m){if(!t.s)return void(t.o=p.bind(null,r,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(p.bind(null,r,e),p.bind(null,r,2));r.s=e,r.v=t;var n=r.o;n&&n(r)}}var m=/*#__PURE__*/function(){function r(){}return r.prototype.then=function(e,t){var n=new r,o=this.s;if(o){var i=1&o?e:t;if(i){try{p(n,1,i(this.v))}catch(r){p(n,2,r)}return n}return this}return this.o=function(r){try{var o=r.v;1&r.s?p(n,1,e?e(o):o):t?p(n,1,t(o)):p(n,2,o)}catch(r){p(n,2,r)}},n},r}();function g(r){return r instanceof m&&1&r.s}var w="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator",I=/*#__PURE__*/function(){function e(r){this.MNEE_TOKEN_ID="ae59f3b898ec61acbdb6cc7a245fabeded0c094bf046f35206a3aec60ef88127_0",this.MNEE_COSIGNER_PROD="020a177d6a5e6f3a8689acd2e313bd1cf0dcf5a243d1cc67b7218602aee9e04b2f",this.MNEE_DECIMALS=5,this.mneeApiToken="92982ec1c0975f31979da515d46bae9f",this.mneeApi="https://proxy-api.mnee.net",this.gorillaPoolApi="https://ordinals.1sat.app",r&&(this.mneeApiToken=r)}var I=e.prototype;return I.getConfig=function(){try{var r=this;return Promise.resolve(v(function(){return Promise.resolve(fetch(r.mneeApi+"/v1/config?auth_token="+r.mneeApiToken,{method:"GET"})).then(function(r){if(!r.ok)throw new Error("HTTP error! status: "+r.status);return Promise.resolve(r.json())})},function(r){console.error("Failed to fetch config:",r)}))}catch(r){return Promise.reject(r)}},I.toAtomicAmount=function(r){return Math.round(r*Math.pow(10,this.MNEE_DECIMALS))},I.createInscription=function(r,e,t){try{var n={p:"bsv-20",op:"transfer",id:t.tokenId,amt:e.toString()};return Promise.resolve({lockingScript:d.applyInscription((new h).lock(r,s.fromString(t.approver)),{dataB64:Buffer.from(JSON.stringify(n)).toString("base64"),contentType:"application/bsv-20"}),satoshis:1})}catch(r){return Promise.reject(r)}},I.getUtxos=function(r,e){void 0===e&&(e=["transfer","deploy+mint"]);try{var t=this;return Promise.resolve(v(function(){return Promise.resolve(fetch(t.mneeApi+"/v1/utxos?auth_token="+t.mneeApiToken,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([r])})).then(function(r){if(!r.ok)throw new Error("HTTP error! status: "+r.status);return Promise.resolve(r.json()).then(function(r){return e.length?r.filter(function(r){return e.includes(r.data.bsv21.op.toLowerCase())}):r})})},function(r){return console.error("Failed to fetch UTXOs:",r),[]}))}catch(r){return Promise.reject(r)}},I.broadcast=function(r){try{var e=this.gorillaPoolApi+"/v5/tx";return Promise.resolve(v(function(){return Promise.resolve(fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:Buffer.from(r.toBinary())})).then(function(r){return Promise.resolve(r.json()).then(function(e){return r.ok?{status:"success",txid:e.txid,message:"Transaction broadcast successfully"}:{status:"error",code:r.status.toString(),description:e.error||"Unknown error"}})})},function(r){return console.error("Failed to broadcast:",r),{status:"error",code:"UNKNOWN",description:r instanceof Error?r.message:"Unknown error"}}))}catch(r){return Promise.reject(r)}},I.fetchBeef=function(r){try{return Promise.resolve(fetch(this.gorillaPoolApi+"/v5/tx/"+r+"/beef")).then(function(e){if(404===e.status)throw new Error("Transaction not found");if(200!==e.status)throw new Error(e.status+" - Failed to fetch beef for tx "+r);var t=Buffer,n=t.from;return Promise.resolve(e.arrayBuffer()).then(function(r){var e=[].concat(n.call(t,r));return u.fromAtomicBEEF(e)})})}catch(r){return Promise.reject(r)}},I.getSignatures=function(e,t){try{try{var i;switch(e.format){case"beef":i=u.fromHexBEEF(e.rawtx);break;case"ef":i=u.fromHexEF(e.rawtx);break;default:i=u.fromHex(e.rawtx)}var s=e.sigRequests.flatMap(function(e){return[t].map(function(t){var s=n.format({sourceTXID:e.prevTxid,sourceOutputIndex:e.outputIndex,sourceSatoshis:e.satoshis,transactionVersion:i.version,otherInputs:i.inputs.filter(function(r,t){return t!==e.inputIndex}),inputIndex:e.inputIndex,outputs:i.outputs,inputSequence:i.inputs[e.inputIndex].sequence||0,subscript:e.script?a.fromHex(e.script):(new c).lock(t.toPublicKey().toAddress()),lockTime:i.lockTime,scope:e.sigHashType||65}),u=t.sign(o.sha256(s)),f=new n(u.r,u.s,e.sigHashType||65);return{sig:r.toHex(f.toChecksigFormat()),pubKey:t.toPublicKey().toString(),inputIndex:e.inputIndex,sigHashType:e.sigHashType||65,csIdx:e.csIdx}})});return Promise.resolve({sigResponses:s})}catch(r){var f;return console.error("getSignatures error",r),Promise.resolve({error:{message:null!=(f=r.message)?f:"unknown",cause:r.cause}})}}catch(r){return Promise.reject(r)}},I.transfer=function(e,t){try{var o=this;return Promise.resolve(v(function(){return Promise.resolve(o.getConfig()).then(function(s){if(!s)throw new Error("Config not fetched");var c=e.reduce(function(r,e){return r+e.amount},0);if(c<=0)return{error:"Invalid amount"};var d=o.toAtomicAmount(c),h=f.fromWif(t),v=h.toAddress();return Promise.resolve(o.getUtxos(v)).then(function(t){var c,f;function v(t){if(f)return t;function i(){function e(){function e(){var e=P.inputs.map(function(r,e){var t,o;if(!r.sourceTXID)throw new Error("Source TXID is undefined");return{prevTxid:r.sourceTXID,outputIndex:r.sourceOutputIndex,inputIndex:e,address:T[e],script:null==(t=r.sourceTransaction)?void 0:t.outputs[r.sourceOutputIndex].lockingScript.toHex(),satoshis:(null==(o=r.sourceTransaction)?void 0:o.outputs[r.sourceOutputIndex].satoshis)||1,sigHashType:n.SIGHASH_ALL|n.SIGHASH_ANYONECANPAY|n.SIGHASH_FORKID}}),t=P.toHex();return Promise.resolve(o.getSignatures({rawtx:t,sigRequests:e},h)).then(function(e){if(null==e||!e.sigResponses)return{error:"Failed to get signatures"};for(var t,n=function(r){var e="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(e)return(e=e.call(r)).next.bind(e);if(Array.isArray(r)||(e=function(r,e){if(r){if("string"==typeof r)return l(r,e);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?l(r,e):void 0}}(r))){e&&(r=e);var t=0;return function(){return t>=r.length?{done:!0}:{done:!1,value:r[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e.sigResponses);!(t=n()).done;){var i=t.value;P.inputs[i.inputIndex].unlockingScript=(new a).writeBin(r.toArray(i.sig,"hex")).writeBin(r.toArray(i.pubKey,"hex"))}var s=r.toBase64(P.toBinary());return Promise.resolve(fetch(o.mneeApi+"/v1/transfer?auth_token="+o.mneeApiToken,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rawtx:s})})).then(function(e){if(!e.ok)throw new Error("HTTP error! status: "+e.status);return Promise.resolve(e.json()).then(function(e){var t=e.rawtx;if(!t)return{error:"Failed to broadcast transaction"};var n=r.toArray(t,"base64"),i=u.fromBinary(n);return Promise.resolve(o.broadcast(i)).then(function(){return{txid:i.id("hex"),rawtx:r.toHex(n)}})})})})}var t=S-d-I,i=function(){if(t>0){var r=P.addOutput;return Promise.resolve(o.createInscription(E,t,s)).then(function(e){r.call(P,e)})}}();return i&&i.then?i.then(e):e()}var t=function(){if(I>0){var r=P.addOutput;return Promise.resolve(o.createInscription(s.feeAddress,I,s)).then(function(e){r.call(P,e)})}}();return t&&t.then?t.then(e):e()}var c=function(r,e){if("function"==typeof r[w]){var t,n,o,i=function(r){try{for(;!(t=s.next()).done;)if((r=e(t.value))&&r.then){if(!g(r))return void r.then(i,o||(o=p.bind(null,n=new m,2)));r=r.v}n?p(n,1,r):n=r}catch(r){p(n||(n=new m),2,r)}},s=r[w]();if(i(),s.return){var u=function(r){try{t.done||s.return()}catch(r){}return r};if(n&&n.then)return n.then(u,function(r){throw u(r)});u()}return n}if(!("length"in r))throw new TypeError("Object is not iterable");for(var a=[],c=0;c<r.length;c++)a.push(r[c]);return function(r,e){var t,n,o=-1;return function i(s){try{for(;++o<r.length;)if((s=e(o))&&s.then){if(!g(s))return void s.then(i,n||(n=p.bind(null,t=new m,2)));s=s.v}t?p(t,1,s):t=s}catch(r){p(t||(t=new m),2,r)}}(),t}(a,function(r){return e(a[r])})}(e,function(r){var e=P.addOutput;return Promise.resolve(o.createInscription(r.address,o.toAtomicAmount(r.amount),s)).then(function(r){e.call(P,r)})});return c&&c.then?c.then(i):i()}if(t.reduce(function(r,e){return r+(e.data.bsv21.amt||0)},0)<d)return{error:"Insufficient MNEE balance"};var I=void 0!==e.find(function(r){return r.address===s.burnAddress})?0:null==(c=s.fees.find(function(r){return d>=r.min&&d<=r.max}))?void 0:c.fee;if(void 0===I)return{error:"Fee ranges inadequate"};var P=new u(1,[],[],0),S=0,T=[],E="",y=function(r,e,t){for(var n;;){var o=r();if(g(o)&&(o=o.v),!o)return i;if(o.then){n=0;break}var i=t();if(i&&i.then){if(!g(i)){n=1;break}i=i.s}}var s=new m,u=p.bind(null,s,2);return(0===n?o.then(c):1===n?i.then(a):(void 0).then(function(){(o=r())?o.then?o.then(c).then(void 0,u):c(o):p(s,1,i)})).then(void 0,u),s;function a(e){i=e;do{if(!(o=r())||g(o)&&!o.v)return void p(s,1,i);if(o.then)return void o.then(c).then(void 0,u);g(i=t())&&(i=i.v)}while(!i||!i.then);i.then(a).then(void 0,u)}function c(r){r?(i=t())&&i.then?i.then(a).then(void 0,u):a(i):p(s,1,i)}}(function(){return!f&&S<d+I},0,function(){var r=t.shift();return r?Promise.resolve(o.fetchBeef(r.txid)).then(function(e){if(!e)return f=1,{error:"Failed to fetch source transaction"};T.push(r.owners[0]),E=E||r.owners[0],P.addInput({sourceTXID:r.txid,sourceOutputIndex:r.vout,sourceTransaction:e,unlockingScript:new i}),S+=r.data.bsv21.amt}):(f=1,{error:"Insufficient MNEE balance"})});return y&&y.then?y.then(v):v(y)})})},function(r){var e="Transaction submission failed";return r instanceof Error&&(e=r.message,r.message.includes("HTTP error")&&console.error("HTTP error details:",r)),console.error("Failed to transfer tokens:",e),{error:e}}))}catch(r){return Promise.reject(r)}},I.getBalance=function(r){try{var e=this;return Promise.resolve(v(function(){return Promise.resolve(e.getConfig()).then(function(t){if(!t)throw new Error("Config not fetched");return Promise.resolve(e.getUtxos(r)).then(function(r){var e=r.reduce(function(r,e){return"transfer"===e.data.bsv21.op&&(r+=e.data.bsv21.amt),r},0);return{amount:e,decimalAmount:parseFloat((e/Math.pow(10,t.decimals||0)).toFixed(t.decimals))}})})},function(r){return console.error("Failed to fetch balance:",r),{amount:0,decimalAmount:0}}))}catch(r){return Promise.reject(r)}},I.validateMneeTx=function(e,n){try{var i=this;try{var s=u.fromHex(e),a=s.outputs.map(function(r){return r.lockingScript}).map(function(e){for(var n=e.chunks,o=0;o<=n.length-6;o++){var i,s;if(n[0+o].op===t.OP_DUP&&n[1+o].op===t.OP_HASH160&&20===(null==(i=n[2+o].data)?void 0:i.length)&&n[3+o].op===t.OP_EQUALVERIFY&&n[4+o].op===t.OP_CHECKSIGVERIFY&&33===(null==(s=n[5+o].data)?void 0:s.length)&&n[6+o].op===t.OP_CHECKSIG)return{cosigner:r.toHex(n[5+o].data||[]),address:r.toBase58Check(n[2+o].data||[],[0])}}});return n?n.forEach(function(e,n){var u,c=e.address,f=e.amount;if(!a.find(function(r){return(null==r?void 0:r.cosigner)===i.MNEE_COSIGNER_PROD}))throw new Error("Cosigner not found for address: "+c+" at index: "+n);if(!a.find(function(r){return(null==r?void 0:r.address)===c}))throw new Error("Address not found in script for address: "+c+" at index: "+n);var d=function(e){for(var n,i,s,u=0;u<e.chunks.length;u++){var a,c=e.chunks[u];u>=2&&3===(null==(a=c.data)?void 0:a.length)&&"ord"==r.toUTF8(c.data)&&e.chunks[u-1].op==t.OP_IF&&e.chunks[u-2].op==t.OP_FALSE&&(s=u+1)}if(void 0!==s){for(var f={file:{hash:"",size:0,type:""},fields:{}},d=s;d<e.chunks.length;d+=2){var l,h,v=e.chunks[d];if(v.op==t.OP_ENDIF)break;if(v.op>t.OP_16)return;var p=e.chunks[d+1];if(p.op>t.OP_PUSHDATA4)return;if(null==(l=v.data)||!l.length){var m=0;switch(v.op>t.OP_PUSHDATA4&&v.op<=t.OP_16?m=v.op-80:null!=(h=v.data)&&h.length&&(m=v.data[0]),m){case 0:if(f.file.size=(null==(n=p.data)?void 0:n.length)||0,null==(i=p.data)||!i.length)break;f.file.hash=r.toBase64(o.sha256(p.data)),f.file.content=p.data;break;case 1:f.file.type=Buffer.from(p.data||[]).toString()}}}return f}}(s.outputs[n].lockingScript),l=null==d||null==(u=d.file)?void 0:u.content;if(!l)throw new Error("Invalid inscription content");var h=r.toUTF8(l);if(!h)throw new Error("Invalid inscription content");var v=JSON.parse(h);if("bsv-20"!==v.p)throw new Error("Invalid bsv 20 protocol: "+v.p);if("transfer"!==v.op)throw new Error("Invalid operation: "+v.op);if(v.id!==i.MNEE_TOKEN_ID)throw new Error("Invalid token id: "+v.id);if(v.amt!==Math.round(f*Math.pow(10,i.MNEE_DECIMALS)).toString())throw new Error("Invalid amount: "+v.amt)}):a.forEach(function(r){if(r&&r.cosigner!==i.MNEE_COSIGNER_PROD)throw new Error("Invalid cosigner: "+r.cosigner)}),Promise.resolve(!0)}catch(r){return console.error(r),Promise.resolve(!1)}}catch(r){return Promise.reject(r)}},e}(),P=/*#__PURE__*/function(){function r(r){this.service=void 0,this.service=new I(r)}var e=r.prototype;return e.validateMneeTx=function(r,e){try{return Promise.resolve(this.service.validateMneeTx(r,e))}catch(r){return Promise.reject(r)}},e.toAtomicAmount=function(r){return this.service.toAtomicAmount(r)},e.config=function(){try{return Promise.resolve(this.service.getConfig())}catch(r){return Promise.reject(r)}},e.balance=function(r){try{return Promise.resolve(this.service.getBalance(r))}catch(r){return Promise.reject(r)}},e.transfer=function(r,e){try{return Promise.resolve(this.service.transfer(r,e))}catch(r){return Promise.reject(r)}},r}();export{P as default};
//# sourceMappingURL=index.module.js.map
